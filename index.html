<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Seed ‚Äî Moisture Detector (Multilingual)</title>
<meta name="description" content="Smart Seed packet moisture detector ‚Äî anthocyanin strip camera analysis. Full UI in English / Malayalam / Hindi." />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f6f8; --card:#fff; --accent:#1e7f3f; --muted:#334155; --good:#15803d; --bad:#c0262e;
}
[data-theme='dark']{ --bg:#071323; --card:#071827; --accent:#38d39f; --muted:#94a3b8; --good:#34d399; --bad:#ff7b7b; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:16px auto;padding:16px}
.header{display:flex;justify-content:space-between;gap:12px;align-items:center}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7ad8a0);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
.title{font-weight:700;color:var(--accent);font-size:18px}
.subtitle{font-size:13px;color:var(--muted)}
.top-controls{display:flex;gap:8px;align-items:center}
.select,button,input{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent}
.btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
.btn.ghost{background:transparent;border:1px dashed rgba(0,0,0,0.06)}
.grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
@media(min-width:980px){ .grid{grid-template-columns:1fr 360px} }
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
.video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000}
video{width:100%;height:auto;display:block;object-fit:cover;background:#000}
.overlay-guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:120px;height:120px;border-radius:50%;border:3px dashed rgba(255,255,255,0.9);box-shadow:0 6px 20px rgba(2,6,23,0.3);pointer-events:none}
.live-swatch{width:64px;height:64px;border-radius:8px;border:1px solid #eee;display:inline-block;vertical-align:middle;background:#fff}
.info{display:inline-block;vertical-align:middle;margin-left:12px}
.metrics{font-size:13px;color:var(--muted)}
.meter{height:18px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);border-radius:12px;overflow:hidden;border:1px solid rgba(0,0,0,0.04);margin-top:8px}
.meter-fill{height:100%;width:0%;transition:width 900ms ease, background 400ms linear;border-radius:12px}
.status{font-weight:700;margin-top:8px}
.small{font-size:13px;color:var(--muted)}
.controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.history-list{max-height:220px;overflow:auto;margin-top:8px}
.hist-item{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
.note{font-size:13px;color:var(--muted);margin-top:10px}
.center{display:flex;align-items:center;justify-content:center}
.loading{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.2);border-top-color:var(--accent);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
.lang-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}
</style>
</head>
<body data-theme="light">
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">SS</div>
      <div>
        <div class="title" id="ui_title">Smart Seed Analyzer</div>
        <div class="subtitle" id="ui_sub">Anthocyanin strip ‚Äî camera moisture check</div>
      </div>
    </div>

    <div class="top-controls">
      <select id="langSelect" class="select" title="Language">
        <option value="en">English</option>
        <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      </select>
      <select id="deviceSelect" class="select" style="display:none"></select>
      <button id="themeToggle" class="btn.ghost" title="Toggle dark">üåó</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: camera and controls -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <label id="ui_seed_label">Seed type</label>
          <select id="seedSelect" class="select">
            <option value="paddy">Paddy</option>
            <option value="wheat">Wheat</option>
            <option value="maize">Maize</option>
            <option value="custom">Custom...</option>
          </select>
          <input id="customName" placeholder="" style="display:none;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);margin-left:8px" />
        </div>
        <div style="display:flex;gap:8px">
          <button id="openCam" class="btn">Open Camera</button>
          <button id="captureBtn" class="btn">üì∏ Capture</button>
          <button id="resetBtn" class="btn.ghost">Reset</button>
        </div>
      </div>

      <div style="margin-top:12px" class="video-wrap card">
        <div style="position:relative">
          <video id="video" playsinline autoplay muted></video>
          <div class="overlay-guide" id="guide"></div>
        </div>

        <div class="controls-row">
          <div class="center">
            <div id="swatch" class="live-swatch"></div>
            <div class="info">
              <div id="rgbText" class="metrics">R - G - B</div>
              <div id="hsvText" class="metrics small"></div>
            </div>
          </div>
          <div style="flex:1">
            <div class="small" id="ui_tip">Place the indicator strip inside packet near center guide. Use diffused light.</div>
            <div class="note" id="cameraNote"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="small" id="ui_instructions">Open camera ‚Üí point to strip ‚Üí capture</div>
    </div>

    <!-- RIGHT: results -->
    <div class="card">
      <div>
        <div class="small" id="ui_detected">Detected</div>
        <div id="detectedState" style="font-weight:700;color:var(--accent)">No sample yet</div>
      </div>

      <div style="margin-top:10px">
        <div class="small">Moisture status</div>
        <div id="statusBadge" style="margin-top:8px"><span class="badge" id="badgeText">--</span></div>

        <div style="margin-top:12px" class="small">Germination prediction</div>
        <div class="meter"><div id="meterFill" class="meter-fill" style="width:0%"></div></div>
        <div id="percentText" style="font-weight:700;margin-top:6px">-- %</div>

        <div id="adviceText" class="small" style="margin-top:8px">Advice shown here.</div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="saveBtn" class="btn">Save</button>
          <button id="downloadBtn" class="btn.ghost">Download Report</button>
          <button id="speakBtn" class="btn.ghost">üîä Speak</button>
          <div id="loader" style="display:none" class="loading"></div>
        </div>

        <div style="margin-top:12px">
          <div class="small">History</div>
          <div id="history" class="history-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top:12px" class="card small">
    <strong id="ui_how">How it works</strong>
    <div id="ui_how_text">The camera samples the strip color and translates color ‚Üí moisture zone ‚Üí germination estimate. Calibrate with white patch for best results.</div>
  </div>

  <div class="footer" id="ui_footer">Made for YIP ‚Ä¢ Works on mobile ‚Äî allow camera permission</div>
</div>

<script>
/* =========================
  Full multilingual UI + advanced detection
   - Option A: full-page translation
   - Advanced detection: center crop + k-means fallback
   - Real-time overlay + live sampling
   - Sound alerts, animated meter, report download & history
========================== */

/* ------------- I18N (English / Malayalam / Hindi) ------------- */
const UI_STRINGS = {
  en: {
    title: 'Smart Seed Analyzer',
    sub: 'Anthocyanin strip ‚Äî camera moisture check',
    seed_label: 'Seed type',
    tip: 'Place the indicator strip inside packet near center guide. Use diffused light.',
    instructions: 'Open camera ‚Üí point to strip ‚Üí capture',
    how: 'How it works',
    how_text: 'The camera samples the strip color and translates color ‚Üí moisture zone ‚Üí germination estimate. Calibrate with white patch for best results.',
    footer: 'Made for YIP ‚Ä¢ Works on mobile ‚Äî allow camera permission',
    open_camera: 'Open Camera',
    capture: 'Capture',
    reset: 'Reset',
    save: 'Save',
    download: 'Download Report',
    speak: 'Speak',
    waiting: 'Waiting for sample‚Ä¶',
    dry_title: 'Too Dry ‚Äî BAD',
    dry_desc: 'Seed too dry ‚Äî germination may drop. Condition seeds.',
    good_title: 'Ideal Moisture ‚Äî GOOD',
    good_desc: 'Perfect moisture for storage and best germination.',
    wet_title: 'Too Wet ‚Äî BAD',
    wet_desc: 'Too much moisture ‚Äî fungus risk. Dry seeds immediately.',
    unknown_title: 'Unknown color',
    unknown_desc: 'Scan again in better lighting.',
    saved: 'Saved to history',
    no_report: 'No report to download'
  },
  ml: {
    title: '‡¥∏‡µç‡¥Æ‡¥æ‡µº‡¥ü‡µç‡¥ü‡µç ‡¥∏‡µÄ‡¥°‡µç ‡¥Ö‡¥®‡¥≤‡µà‡¥∏‡µº',
    sub: '‡¥Ü‡¥®‡µç‡¥§‡µã‡¥∏‡¥Ø‡¥æ‡¥®‡¥ø‡µª ‡¥∏‡µç‡¥±‡µç‡¥±‡µç‡¥∞‡¥ø‡¥™‡µç‡¥™‡µç ‚Äî ‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥Æ‡µã‡¥∏‡µç‚Äå‡¥ö‡µº ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥®',
    seed_label: '‡¥¨‡µÄ‡¥ú ‡¥§‡¥∞‡¥Ç',
    tip: '‡¥∏‡µÇ‡¥ö‡¥ø‡¥ï ‡¥∏‡µç‡¥±‡µç‡¥±‡µç‡¥∞‡¥ø‡¥™‡µç‡¥™‡µç ‡¥™‡¥æ‡¥ï‡µç‡¥ï‡¥±‡µç‡¥±‡¥ø‡¥®‡µÅ‡¥≥‡µç‡¥≥‡¥ø‡µΩ ‡¥Æ‡¥ß‡µç‡¥Ø‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥µ‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µÅ‡¥ï. ‡¥Æ‡µÉ‡¥¶‡µÅ‡¥µ‡¥æ‡¥Ø ‡¥™‡µç‡¥∞‡¥ï‡¥æ‡¥∂‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.',
    instructions: '‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥§‡µÅ‡¥±‡¥ï‡µç‡¥ï‡µÅ‡¥ï ‚Üí ‡¥∏‡µç‡¥±‡µç‡¥±‡µç‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥®‡µã‡¥ü‡µç ‡¥§‡µÅ‡¥±‡¥®‡µç‡¥®‡µç ‚Üí ‡¥ï‡µç‡¥Ø‡¥æ‡¥™‡µç‡¥ö‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï',
    how: '‡¥é‡¥ô‡µç‡¥ô‡¥®‡µÜ ‡¥™‡µç‡¥∞‡¥µ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ',
    how_text: '‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥∏‡µç‡¥±‡µç‡¥±‡µç‡¥∞‡¥ø‡¥™‡µç‡¥™‡µç ‡¥®‡¥ø‡¥±‡¥Ç ‡¥∏‡¥æ‡¥Æ‡µç‡¥™‡¥ø‡µæ ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µç ‡¥®‡¥ø‡¥±‡¥Ç ‚Üí ‡Æà‡µº‡¥™‡µç‡¥™‡¥Ç ‡¥∏‡µç‡¥•‡¥ø‡¥§‡¥ø ‚Üí ‡¥Æ‡µÅ‡¥≥‡¥µ‡¥≤‡µÅ‡¥ô‡µç‡¥ï‡µΩ ‡¥®‡¥ø‡¥∞‡¥ï‡µç‡¥ï‡µç ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ. ‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥´‡¥≤‡¥Ç ‡¥®‡µá‡¥ü‡¥æ‡µª ‡¥µ‡µà‡¥±‡µç‡¥±‡µç ‡¥™‡¥æ‡¥ö‡µç‡¥ö‡µç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µÅ‡¥ï‡µÜ‡¥æ‡¥≥‡µç‡¥≤‡µÅ‡¥ï.',
    footer: 'YIP ‡¥®‡µç‡¥®‡µç ‡¥µ‡µá‡¥£‡µç‡¥ü‡¥ø ‡¥®‡¥ø‡µº‡¥Æ‡µç‡¥Æ‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ ‚Ä¢ ‡¥Æ‡µä‡¥¨‡µà‡¥≤‡¥ø‡µΩ ‡¥™‡µç‡¥∞‡¥µ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ ‚Äî ‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥Ö‡¥®‡µÅ‡¥µ‡¥æ‡¥¶‡¥Ç ‡¥Ö‡¥®‡µÅ‡¥µ‡¥¶‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï',
    open_camera: '‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥§‡µÅ‡¥±‡¥ï‡µç‡¥ï‡µÅ‡¥ï',
    capture: '‡¥ï‡µç‡¥Ø‡¥æ‡¥™‡µç‡¥ö‡µº',
    reset: '‡¥±‡µÄ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç',
    save: '‡¥∏‡µá‡¥µ‡µç',
    download: '‡¥±‡¥ø‡¥™‡µç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç ‡¥°‡µó‡µ∫‡¥≤‡µã‡¥°‡µç',
    speak: '‡¥™‡¥±‡¥Ø‡µÅ‡¥ï',
    waiting: '‡¥∏‡¥æ‡¥Æ‡µç‡¥™‡¥ø‡µæ ‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‚Ä¶',
    dry_title: '‡¥µ‡¥≥‡µç‡¥≥‡¥ø ‡¥µ‡¥∞‡¥£‡µç‡¥ü‡¥§‡µç ‚Äî ‡¥Æ‡µã‡¥∂‡¥Ç',
    dry_desc: '‡¥¨‡µÄ‡¥ú‡¥Ç ‡¥µ‡¥≥‡¥∞‡µÜ ‡¥µ‡¥∞‡¥£‡µç‡¥ü‡¥§‡¥æ‡¥£‡µç ‚Äî ‡¥Æ‡µÅ‡¥≥‡¥µ‡µΩ ‡¥ï‡µÅ‡¥±‡¥Ø‡¥æ‡¥Ç. ‡¥ú‡¥≤‡¥Æ‡µã‡¥∂‡¥®‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï.',
    good_title: '‡¥∏‡µº‡¥µ‡µã‡¥§‡µç‡¥Ç ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç ‚Äî ‡¥®‡¥≤‡µç‡¥≤‡¥§‡µç',
    good_desc: '‡¥∏‡¥Ç‡¥≠‡¥∞‡¥£‡¥§‡µç‡¥§‡¥ø‡¥®‡µÅ‡¥Ç ‡¥Æ‡µÅ‡¥≥‡¥µ‡µΩ‡¥ï‡µç‡¥ï‡µÅ‡¥Æ‡µÅ‡¥≥‡µç‡¥≥ ‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥à‡µº‡¥™‡µç‡¥™‡µç.',
    wet_title: '‡¥Ö‡¥§‡¥ø ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç ‚Äî ‡¥Æ‡µã‡¥∂‡¥Ç',
    wet_desc: '‡¥é‡¥§‡µç‡¥∞‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡¥≤‡¥æ‡¥£‡µç ‚Äî ‡¥´‡¥Ç‡¥ó‡¥∏‡µç ‡¥≠‡µÄ‡¥∑‡¥£‡¥ø. ‡¥â‡¥ü‡¥®‡µÜ ‡¥â‡¥£‡¥ï‡µç‡¥ï‡µÅ‡¥ï.',
    unknown_title: '‡¥Ö‡¥±‡¥ø‡¥Ø‡¥æ‡¥®‡¥æ‡¥Ø‡¥ø‡¥≤‡µç‡¥≤',
    unknown_desc: '‡¥Æ‡¥ø‡¥ï‡¥µ‡µÅ‡¥±‡µç‡¥± ‡¥™‡µç‡¥∞‡¥ï‡¥æ‡¥∂‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥∏‡µç‡¥ï‡¥æ‡µª ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï.',
    saved: '‡¥ö‡¥∞‡¥ø‡¥§‡µç‡¥∞‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ',
    no_report: '‡¥°‡µó‡µ∫‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥±‡¥ø‡¥™‡µç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç ‡¥á‡¥≤‡µç‡¥≤'
  },
  hi: {
    title: '‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∏‡•Ä‡§° ‡§è‡§®‡§æ‡§≤‡§æ‡§á‡§ú‡§º‡§∞',
    sub: '‡§è‡§Ç‡§•‡•ã‡§∏‡§æ‡§Ø‡§®‡§ø‡§® ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§™ ‚Äî ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ ‡§ú‡§æ‡§Å‡§ö',
    seed_label: '‡§¨‡•Ä‡§ú ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',
    tip: '‡§á‡§Ç‡§°‡§ø‡§ï‡•á‡§ü‡§∞ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§™ ‡§ï‡•ã ‡§™‡•à‡§ï‡•á‡§ü ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§∞‡§ñ‡•á‡§Ç‡•§ ‡§´‡•à‡§≤‡§æ‡§µ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§',
    instructions: '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç ‚Üí ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§™ ‡§™‡§∞ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ï‡§∞‡•á‡§Ç ‚Üí ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç',
    how: '‡§Ø‡§π ‡§ï‡•à‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à',
    how_text: '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§™ ‡§∞‡§Ç‡§ó ‡§ï‡§æ ‡§®‡§Æ‡•Ç‡§®‡§æ ‡§≤‡•á‡§ï‡§∞ ‡§â‡§∏‡•á ‡§®‡§Æ‡•Ä ‡§ú‡§º‡•ã‡§® ‡§î‡§∞ ‡§Ö‡§Ç‡§ï‡•Å‡§∞‡§£ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§¨‡•á‡§π‡§§‡§∞ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§´‡•á‡§¶ ‡§™‡•à‡§ö ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§',
    footer: 'YIP ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚Ä¢ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‚Äî ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç',
    open_camera: '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç',
    capture: '‡§ï‡•à‡§™‡•ç‡§ö‡§∞',
    reset: '‡§∞‡•Ä‡§∏‡•á‡§ü',
    save: '‡§∏‡•á‡§µ',
    download: '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°',
    speak: '‡§¨‡•ã‡§≤‡•á‡§Ç',
    waiting: '‡§®‡§Æ‡•Ç‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ‚Ä¶',
    dry_title: '‡§¨‡§π‡•Å‡§§ ‡§∏‡•Ç‡§ñ‡§æ ‚Äî ‡§ñ‡§∞‡§æ‡§¨',
    dry_desc: '‡§¨‡•Ä‡§ú ‡§¨‡§π‡•Å‡§§ ‡§∏‡•Ç‡§ñ‡§æ ‡§π‡•à ‚Äî ‡§Ö‡§Ç‡§ï‡•Å‡§∞‡§£ ‡§ó‡§ø‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§®‡§Æ‡•Ä ‡§¶‡•á‡§Ç‡•§',
    good_title: '‡§â‡§ö‡§ø‡§§ ‡§®‡§Æ‡•Ä ‚Äî ‡§Ö‡§ö‡•ç‡§õ‡§æ',
    good_desc: '‡§≠‡§Ç‡§°‡§æ‡§∞‡§£ ‡§î‡§∞ ‡§â‡§§‡•ç‡§§‡§Æ ‡§Ö‡§Ç‡§ï‡•Å‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§π‡•Ä ‡§®‡§Æ‡•Ä‡•§',
    wet_title: '‡§¨‡§π‡•Å‡§§ ‡§ó‡•Ä‡§≤‡§æ ‚Äî ‡§ñ‡§∞‡§æ‡§¨',
    wet_desc: '‡§Ö‡§ß‡§ø‡§ï ‡§®‡§Æ‡•Ä ‚Äî ‡§´‡§Ç‡§ó‡§∏ ‡§ï‡§æ ‡§ñ‡§§‡§∞‡§æ‡•§ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§∏‡•Å‡§ñ‡§æ‡§è‡§Ç‡•§',
    unknown_title: '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§∞‡§Ç‡§ó',
    unknown_desc: '‡§¨‡•á‡§π‡§§‡§∞ ‡§∞‡•ã‡§∂‡§®‡•Ä ‡§Æ‡•á‡§Ç ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç‡•§',
    saved: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ',
    no_report: '‡§°ownload ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç'
  }
};

/* ------------- Elements ------------- */
const langSelect = document.getElementById('langSelect');
const ui_title = document.getElementById('ui_title');
const ui_sub = document.getElementById('ui_sub');
const ui_seed_label = document.getElementById('ui_seed_label');
const ui_tip = document.getElementById('ui_tip');
const ui_instructions = document.getElementById('ui_instructions');
const ui_how = document.getElementById('ui_how');
const ui_how_text = document.getElementById('ui_how_text');
const ui_footer = document.getElementById('ui_footer');

const deviceSelect = document.getElementById('deviceSelect');
const themeToggle = document.getElementById('themeToggle');

const openCamBtn = document.getElementById('openCam');
const captureBtn = document.getElementById('captureBtn');
const resetBtn = document.getElementById('resetBtn');

const video = document.getElementById('video');
const swatch = document.getElementById('swatch');
const rgbText = document.getElementById('rgbText');
const hsvText = document.getElementById('hsvText');
const cameraNote = document.getElementById('cameraNote');

const detectedState = document.getElementById('detectedState');
const badgeText = document.getElementById('badgeText');
const meterFill = document.getElementById('meterFill');
const percentText = document.getElementById('percentText');
const adviceText = document.getElementById('adviceText');

const saveBtn = document.getElementById('saveBtn');
const downloadBtn = document.getElementById('downloadBtn');
const speakBtn = document.getElementById('speakBtn');
const historyEl = document.getElementById('history');
const loader = document.getElementById('loader');

const seedSelect = document.getElementById('seedSelect');
const customName = document.getElementById('customName');

let stream = null;
let devicesList = [];
let lastReport = null;
let liveInterval = null;

/* ------------- Theme toggle ------------- */
themeToggle.addEventListener('click', ()=>{
  const b = document.body;
  const cur = b.getAttribute('data-theme') || 'light';
  const next = cur === 'light' ? 'dark' : 'light';
  b.setAttribute('data-theme', next);
  localStorage.setItem('ss-theme', next);
});
if(localStorage.getItem('ss-theme')) document.body.setAttribute('data-theme', localStorage.getItem('ss-theme'));

/* ------------- Language switching (full UI) ------------- */
function applyLanguage(){
  const L = langSelect.value || 'en';
  const S = UI_STRINGS[L];
  ui_title.innerText = S.title;
  ui_sub.innerText = S.sub;
  ui_seed_label.innerText = S.seed_label;
  ui_tip.innerText = S.tip;
  ui_instructions.innerText = S.instructions;
  ui_how.innerText = S.how;
  ui_how_text.innerText = S.how_text;
  ui_footer.innerText = S.footer;
  openCamBtn.innerText = S.open_camera;
  captureBtn.innerText = S.capture;
  resetBtn.innerText = S.reset;
  saveBtn.innerText = S.save;
  downloadBtn.innerText = S.download;
  speakBtn.innerText = S.speak;
  badgeText.innerText = '--';
  detectedState.innerText = S.waiting;
  adviceText.innerText = '';
}
langSelect.addEventListener('change', applyLanguage);
applyLanguage();

/* ------------- enumerate devices and fill deviceSelect if available ------------- */
async function listVideoDevices(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    devicesList = devices.filter(d => d.kind === 'videoinput');
    if(devicesList.length > 1){
      deviceSelect.style.display = 'inline-block';
      deviceSelect.innerHTML = '';
      devicesList.forEach(d => {
        const label = d.label || ('Camera ' + d.deviceId.slice(0,4));
        const o = document.createElement('option'); o.value = d.deviceId; o.innerText = label; deviceSelect.appendChild(o);
      });
    }
  }catch(e){ console.warn('enumerateDevices failed', e); }
}
listVideoDevices();

/* ------------- open camera robustly ------------- */
async function openCamera(deviceId){
  closeStream();
  cameraNote.innerText = '';
  try{
    let constraints;
    if(deviceId) constraints = { video: { deviceId: { exact: deviceId } , width: { ideal: 1280 }, height: { ideal:720 } } };
    else constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal:720 } } };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play().catch(()=>{});
    cameraNote.innerText = '';
    // update device list & select if present
    listVideoDevices();
    startLiveSampling();
  }catch(e){
    console.error('openCamera error', e);
    cameraNote.innerText = 'Camera access failed. Check permission or try selecting another camera from dropdown.';
    // try fallback simple camera
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:true });
      video.srcObject = stream;
      await video.play();
      startLiveSampling();
    }catch(err){
      console.error('fallback failed', err);
      cameraNote.innerText = 'Camera not available. Try another browser.';
    }
  }
}
openCamBtn.addEventListener('click', ()=> openCamera(deviceSelect.value || null));
deviceSelect.addEventListener('change', ()=> openCamera(deviceSelect.value));

function closeStream(){
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  if(liveInterval) { clearInterval(liveInterval); liveInterval = null; }
}

/* ------------- live sampling (for preview) ------------- */
const tempCanvas = document.createElement('canvas');
function startLiveSampling(){
  if(liveInterval) clearInterval(liveInterval);
  liveInterval = setInterval(()=> sampleFrame(true), 800);
}
function stopLiveSampling(){
  if(liveInterval) clearInterval(liveInterval); liveInterval = null;
}

/* ------------- capture & analyze ------------- */
captureBtn.addEventListener('click', ()=> sampleFrame(false));
resetBtn.addEventListener('click', clearAll);

function sampleFrame(isLive){
  if(!stream){ alert('Open camera first'); return; }
  const vw = video.videoWidth, vh = video.videoHeight;
  if(!vw || !vh) return;
  // center crop (guide circle area)
  const cropW = Math.floor(vw * 0.28);
  const cropH = Math.floor(vh * 0.28);
  const sx = Math.floor((vw - cropW)/2);
  const sy = Math.floor((vh - cropH)/2);
  tempCanvas.width = cropW; tempCanvas.height = cropH;
  const ctx = tempCanvas.getContext('2d');
  ctx.drawImage(video, sx, sy, cropW, cropH, 0,0,cropW,cropH);

  // advanced detection: try k-means for dominant color for robustness (small k)
  const img = ctx.getImageData(0,0,cropW,cropH);
  const sample = sampleImagePixels(img, 500); // sample up to 500 pixels
  let dominant = getDominantColorKMeans(sample, 3);
  // fallback to average if kmeans fails
  if(!dominant) dominant = averageColor(sample);

  const r = dominant[0], g = dominant[1], b = dominant[2];
  swatch.style.background = `rgb(${r},${g},${b})`;
  rgbText.innerText = `R ${r} ‚Ä¢ G ${g} ‚Ä¢ B ${b}`;
  const hsv = rgbToHsv(r,g,b);
  hsvText.innerText = `H ${Math.round(hsv[0])}¬∞ ‚Ä¢ S ${Math.round(hsv[1]*100)}% ‚Ä¢ V ${Math.round(hsv[2]*100)}%`;

  if(!isLive){
    analyzeAndShow({r,g,b,hsv});
  } else {
    // store preview for quick save
    lastReport = { seed: getSeedName(), r,g,b,hsv, ts: new Date().toISOString() };
  }
}

/* ------------- image sampling helpers ------------- */
function sampleImagePixels(imgData, maxSamples){
  const pixels = [];
  const data = imgData.data;
  const total = data.length / 4;
  const step = Math.max(1, Math.floor(total / maxSamples));
  for(let i=0;i<total;i+=step){
    const idx = i*4;
    pixels.push([data[idx], data[idx+1], data[idx+2]]);
  }
  return pixels;
}
function averageColor(pixels){
  let r=0,g=0,b=0;
  pixels.forEach(p => { r+=p[0]; g+=p[1]; b+=p[2]; });
  const c = Math.max(1, pixels.le